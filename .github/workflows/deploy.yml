name: Build and Deploy ms-customers

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP_NAME }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_NAME: lanchonete-customers
  MS_NAME: ms-customers

jobs:
  build-and-test:
    name: 'Build, Test & SonarCloud'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup .NET'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: 'Restore dependencies'
        run: dotnet restore

      - name: 'Build'
        run: dotnet build --no-restore --configuration Release

      - name: 'Run tests with coverage'
        run: |
          dotnet test --no-build --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx;LogFileName=test-results.trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: 'Setup Java'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 'Install SonarScanner'
        run: |
          dotnet tool install --global dotnet-sonarscanner
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: 'SonarCloud Analysis'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /o:"${{ secrets.SONAR_ORGANIZATION }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" \
            /d:sonar.qualitygate.wait=true
          
          dotnet build --no-restore --configuration Release
          
          dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: 'Upload test results'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: ./TestResults

  deploy:
    name: 'Docker Build & Deploy to AKS'
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Docker Login to ACR'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      - name: 'Build Docker image'
        run: |
          docker build \
            -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
            .

      - name: 'Push Docker image to ACR'
        run: |
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name: 'Set AKS context'
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - name: 'Ensure AKS-ACR integration'
        run: |
          az aks update --name ${{ env.AKS_CLUSTER_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} \
            --attach-acr ${{ env.ACR_LOGIN_SERVER }} || echo "ACR already attached"

      - name: 'Create/Update Kubernetes secrets'
        run: |
          kubectl create secret generic ms-customers-secrets \
            --from-literal=ConnectionStrings__Default='${{ secrets.DB_CONNECTION_STRING }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: 'Replace placeholders in manifests'
        run: |
          find ./k8s -type f -name "*.yaml" -exec sed -i "s|__ACR_LOGIN_SERVER__|${{ env.ACR_LOGIN_SERVER }}|g" {} +
          find ./k8s -type f -name "*.yaml" -exec sed -i "s|__IMAGE_TAG__|${{ env.IMAGE_TAG }}|g" {} +
          find ./k8s -type f -name "*.yaml" -exec sed -i "s|__IMAGE_NAME__|${{ env.IMAGE_NAME }}|g" {} +

      - name: 'Deploy to AKS'
        run: kubectl apply -f k8s/

      - name: 'Verify deployment'
        run: |
          kubectl rollout status deployment/ms-customers-deployment --timeout=5m
          kubectl get pods -l app=ms-customers

      - name: 'Azure Logout'
        if: always()
        run: az logout